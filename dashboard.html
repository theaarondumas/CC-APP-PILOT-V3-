<script>
/**
 * VERIFI Dashboard — auto-detect localStorage data
 * - Finds likely VERIFI keys
 * - Tries to parse JSON
 * - Picks the best candidate automatically
 * - Shows a debug panel so you can see what's stored (even on iPhone)
 */

function safeParseJSON(str) {
  try { return JSON.parse(str); } catch { return null; }
}

function isLikelyVerifiKey(k) {
  const s = String(k).toLowerCase();
  // filter out obvious extension noise
  if (s.includes("copilot") || s.includes("jump_to") || s.includes("ref-selector")) return false;
  // likely app keys
  return (
    s.includes("verifi") ||
    s.includes("crash") ||
    s.includes("cart") ||
    s.includes("nurse") ||
    s.includes("round") ||
    s.includes("cc-") ||
    s.includes("pilot")
  );
}

function scoreCandidate(obj) {
  // higher score = more likely to be your verification dataset
  let score = 0;

  if (Array.isArray(obj)) {
    score += 10;
    if (obj.length) score += Math.min(20, obj.length);
    const sample = obj[0] || {};
    const keys = Object.keys(sample || {}).map(k => k.toLowerCase());
    if (keys.some(k => k.includes("cart"))) score += 15;
    if (keys.some(k => k.includes("risk") || k.includes("exception"))) score += 10;
    if (keys.some(k => k.includes("date") || k.includes("time"))) score += 5;
    if (keys.some(k => k.includes("tech") || k.includes("user") || k.includes("checked"))) score += 5;
  } else if (obj && typeof obj === "object") {
    score += 5;
    const topKeys = Object.keys(obj).map(k => k.toLowerCase());
    if (topKeys.some(k => k.includes("carts"))) score += 12;
    if (topKeys.some(k => k.includes("round") || k.includes("verification"))) score += 10;
    if (topKeys.some(k => k.includes("log") || k.includes("audit"))) score += 8;
    // If it has nested arrays, boost
    for (const k of Object.keys(obj)) {
      if (Array.isArray(obj[k])) score += 8;
    }
  }

  return score;
}

function extractRecords(candidateObj) {
  // Try to normalize to an array of “record-like” objects
  if (Array.isArray(candidateObj)) return candidateObj;

  if (candidateObj && typeof candidateObj === "object") {
    // common patterns
    if (Array.isArray(candidateObj.records)) return candidateObj.records;
    if (Array.isArray(candidateObj.verifications)) return candidateObj.verifications;
    if (Array.isArray(candidateObj.carts)) return candidateObj.carts;
    if (Array.isArray(candidateObj.items)) return candidateObj.items;

    // Search first array we can find
    for (const k of Object.keys(candidateObj)) {
      if (Array.isArray(candidateObj[k]) && candidateObj[k].length) return candidateObj[k];
    }
  }
  return [];
}

function renderDebug(keysInfo, pickedKey) {
  // Create a simple debug panel at bottom (only if not already present)
  let dbg = document.getElementById("debugPanel");
  if (!dbg) {
    dbg = document.createElement("div");
    dbg.id = "debugPanel";
    dbg.style.marginTop = "18px";
    dbg.style.border = "1px solid #e3e3e3";
    dbg.style.borderRadius = "12px";
    dbg.style.padding = "12px 14px";
    dbg.style.background = "#fff";
    dbg.style.fontSize = "12px";
    dbg.style.color = "#333";

    const wrap = document.querySelector(".wrap");
    wrap.appendChild(dbg);
  }

  const lines = keysInfo
    .map(x => `${x.key}  —  ${x.len} chars`)
    .join("<br/>");

  dbg.innerHTML = `
    <div style="font-weight:900; margin-bottom:6px;">Debug (localStorage on THIS device)</div>
    <div style="margin-bottom:6px;">
      <b>Picked key:</b> <span style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace;">${pickedKey || "none"}</span>
    </div>
    <div style="opacity:0.8; margin-bottom:8px;">If you don't see any VERIFI-looking keys below, the app hasn't saved on this device/domain yet.</div>
    <div style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace; line-height:1.4;">${lines || "(no keys found)"}</div>
  `;
}

function loadMetricsAuto() {
  // 1) Gather keys + sizes
  const allKeys = Object.keys(localStorage || {});
  const keysInfo = allKeys
    .filter(isLikelyVerifiKey)
    .map(k => ({ key: k, len: (localStorage.getItem(k) || "").length }))
    .sort((a,b) => b.len - a.len);

  // If nothing likely found, still show debug
  if (!keysInfo.length) {
    renderDebug([], null);
    // Set metrics to 0 (but don’t crash)
    document.getElementById("m_verified").textContent = "0";
    document.getElementById("m_followup").textContent = "0";
    return;
  }

  // 2) Try parse + score each candidate
  let best = { key: null, obj: null, score: -1 };

  for (const info of keysInfo) {
    const raw = localStorage.getItem(info.key);
    const parsed = safeParseJSON(raw);
    if (!parsed) continue;

    const score = scoreCandidate(parsed);
    if (score > best.score) best = { key: info.key, obj: parsed, score };
  }

  renderDebug(keysInfo, best.key);

  // 3) Extract normalized records array
  const records = extractRecords(best.obj);
  const verifiedCount = Array.isArray(records) ? records.length : 0;

  // 4) Follow-up heuristic (works even if property names differ)
  const followUpCount = (records || []).filter(r => {
    if (!r || typeof r !== "object") return false;
    const keys = Object.keys(r);
    // look for any boolean-ish flags
    for (const k of keys) {
      const lk = k.toLowerCase();
      if (lk.includes("risk") || lk.includes("exception") || lk.includes("follow")) {
        const v = r[k];
        if (v === true) return true;
        if (typeof v === "string" && v.toLowerCase().includes("true")) return true;
      }
    }
    return false;
  }).length;

  document.getElementById("m_verified").textContent = String(verifiedCount);
  document.getElementById("m_followup").textContent = String(followUpCount);

  // 5) Recent activity: show last 5 records with whatever identifier we can find
  const activityBox = document.getElementById("activity");
  activityBox.innerHTML = "";

  const last = (records || []).slice(-5).reverse();
  if (!last.length) {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = "• No recent activity detected yet.";
    activityBox.appendChild(div);
  } else {
    last.forEach(r => {
      const cart =
        r.cartId || r.cartID || r.cartNumber || r.cart || r.id || r.name || "Cart";
      const when =
        r.updatedAt || r.updated_at || r.timestamp || r.time || r.date || "";
      const label = when ? `${when} — ${cart} updated` : `${cart} updated`;

      const div = document.createElement("div");
      div.className = "item";
      div.textContent = "• " + label;
      activityBox.appendChild(div);
    });
  }
}

loadMetricsAuto();
</script>
</body>
</html>

