<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VERIFI — Executive Dashboard</title>

  <!-- Keep your existing stylesheet for consistent vibe -->
  <link rel="stylesheet" href="styles.css?v=1" />

  <style>
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .top h1 { margin: 0; font-size: 32px; letter-spacing: 0.5px; }
    .top p { margin: 6px 0 0; color: #9aa0a6; }
    .nav { margin-top: 10px; }
    .nav a { text-decoration: none; font-weight: 800; }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin: 18px 0 22px; }
    .card { border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 16px; background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); }
    .label { font-size: 12px; color: #c6cbd1; margin-bottom: 8px; }
    .value { font-size: 28px; font-weight: 900; color: #fff; }

    .sectionTitle { font-size: 18px; font-weight: 900; margin: 18px 0 10px; color: #fff; display:flex; align-items:center; gap:10px; }
    .badge { display:inline-block; font-size: 12px; padding: 3px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,0.18); color:#fff; }
    .warn { background: rgba(255, 200, 0, 0.12); border-color: rgba(255, 200, 0, 0.35); }
    .ok { background: rgba(0, 255, 120, 0.10); border-color: rgba(0, 255, 120, 0.25); }

    .list { border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 14px 16px; background: rgba(255,255,255,0.06); }
    .item { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.08); color: #fff; }
    .item:last-child { border-bottom: 0; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }

    .muted { color: #c6cbd1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Debug panel */
    .debug { margin-top: 18px; border-radius: 12px; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); color:#fff; }
    .debug h3 { margin: 0 0 8px; font-size: 14px; }
    .debug .small { font-size: 12px; color:#c6cbd1; line-height:1.35; }
    .debug .keys { margin-top: 8px; font-size: 12px; line-height: 1.4; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>VERIFI</h1>
      <p>Executive Overview — This Week</p>
      <div class="nav"><a href="index.html">← Back</a></div>
    </div>

    <!-- Metric Cards -->
    <div class="grid">
      <div class="card">
        <div class="label">Checks Completed (This Week)</div>
        <div class="value" id="m_verified">0</div>
      </div>
      <div class="card">
        <div class="label">Needs Follow-Up</div>
        <div class="value" id="m_followup">0</div>
      </div>
      <div class="card">
        <div class="label">Avg Time to Resolve</div>
        <div class="value" id="m_ttr">—</div>
      </div>
      <div class="card">
        <div class="label">Active Users</div>
        <div class="value" id="m_users">—</div>
      </div>
    </div>

    <!-- Needs Attention -->
    <div class="sectionTitle">Needs Attention <span class="badge warn">Open</span></div>
    <div class="list" id="needs_attention">
      <div class="item muted">No open items detected yet.</div>
    </div>

    <!-- Activity -->
    <div class="sectionTitle">Recent Activity <span class="badge ok">Live Log</span></div>
    <div class="list" id="activity">
      <div class="item muted">No recent activity detected yet.</div>
    </div>

    <!-- Debug -->
    <div class="debug" id="debugPanel">
      <h3>Debug (This Device)</h3>
      <div class="small">
        If metrics stay at 0, this panel will show which localStorage key your VERIFI app is actually using.
      </div>
      <div class="keys mono" id="debugKeys">(loading…)</div>
      <div class="small" style="margin-top:8px;">
        <b>Picked key:</b> <span class="mono" id="debugPicked">—</span>
      </div>
    </div>
  </div>

  <script>
    // --------- Safe helpers ----------
    function safeParseJSON(str) {
      try { return JSON.parse(str); } catch { return null; }
    }

    function isNoiseKey(k) {
      const s = String(k).toLowerCase();
      return s.includes("copilot") || s.includes("jump_to") || s.includes("ref-selector") || s.includes("extension");
    }

    function isLikelyAppKey(k) {
      const s = String(k).toLowerCase();
      if (isNoiseKey(s)) return false;
      return (
        s.includes("verifi") ||
        s.includes("crash") ||
        s.includes("cart") ||
        s.includes("nurse") ||
        s.includes("round") ||
        s.includes("pilot") ||
        s.includes("cc")
      );
    }

    function scoreCandidate(obj) {
      let score = 0;

      if (Array.isArray(obj)) {
        score += 15;
        score += Math.min(30, obj.length);
        const sample = obj[0] || {};
        const keys = Object.keys(sample || {}).map(k => k.toLowerCase());
        if (keys.some(k => k.includes("cart") || k.includes("department") || k.includes("unit"))) score += 20;
        if (keys.some(k => k.includes("risk") || k.includes("exception") || k.includes("follow"))) score += 12;
        if (keys.some(k => k.includes("date") || k.includes("time") || k.includes("updated"))) score += 8;
        if (keys.some(k => k.includes("tech") || k.includes("checked") || k.includes("user") || k.includes("initial"))) score += 6;
      } else if (obj && typeof obj === "object") {
        score += 8;
        const topKeys = Object.keys(obj).map(k => k.toLowerCase());
        if (topKeys.some(k => k.includes("carts") || k.includes("verifications") || k.includes("records"))) score += 20;
        if (topKeys.some(k => k.includes("round") || k.includes("log") || k.includes("audit"))) score += 14;
        for (const k of Object.keys(obj)) {
          if (Array.isArray(obj[k])) score += 10;
        }
      }
      return score;
    }

    function extractRecords(candidateObj) {
      if (Array.isArray(candidateObj)) return candidateObj;

      if (candidateObj && typeof candidateObj === "object") {
        if (Array.isArray(candidateObj.records)) return candidateObj.records;
        if (Array.isArray(candidateObj.verifications)) return candidateObj.verifications;
        if (Array.isArray(candidateObj.carts)) return candidateObj.carts;
        if (Array.isArray(candidateObj.items)) return candidateObj.items;

        // first non-empty array
        for (const k of Object.keys(candidateObj)) {
          if (Array.isArray(candidateObj[k]) && candidateObj[k].length) return candidateObj[k];
        }
      }
      return [];
    }

    function getRecordId(r) {
      return r?.cartId || r?.cartID || r?.cartNumber || r?.cart || r?.id || r?.name || "Cart";
    }

    function getRecordWhen(r) {
      return r?.updatedAt || r?.updated_at || r?.timestamp || r?.time || r?.date || "";
    }

    function isFollowUp(r) {
      if (!r || typeof r !== "object") return false;
      for (const k of Object.keys(r)) {
        const lk = k.toLowerCase();
        if (lk.includes("risk") || lk.includes("exception") || lk.includes("follow")) {
          const v = r[k];
          if (v === true) return true;
          if (typeof v === "string" && v.toLowerCase().includes("true")) return true;
          if (typeof v === "string" && (v.toLowerCase().includes("risk") || v.toLowerCase().includes("exception"))) return true;
        }
      }
      return false;
    }

    function renderList(el, rows) {
      el.innerHTML = "";
      if (!rows.length) {
        const div = document.createElement("div");
        div.className = "item muted";
        div.textContent = "No items detected yet.";
        el.appendChild(div);
        return;
      }
      rows.forEach(row => {
        const div = document.createElement("div");
        div.className = "item row";
        div.innerHTML = `
          <div>${row.left}</div>
          ${row.right ? `<span class="badge warn">${row.right}</span>` : ""}
        `;
        el.appendChild(div);
      });
    }

    function loadDashboard() {
      const allKeys = Object.keys(localStorage || {});
      const filtered = allKeys
        .filter(isLikelyAppKey)
        .map(k => ({ key: k, len: (localStorage.getItem(k) || "").length }))
        .sort((a,b) => b.len - a.len);

      // Debug list of keys
      const debugKeysEl = document.getElementById("debugKeys");
      debugKeysEl.innerHTML = filtered.length
        ? filtered.map(x => `${x.key} — ${x.len} chars`).join("<br/>")
        : "(No VERIFI-looking keys found yet)";

      // Pick best JSON candidate
      let best = { key: null, obj: null, score: -1 };

      for (const info of filtered) {
        const raw = localStorage.getItem(info.key);
        const parsed = safeParseJSON(raw);
        if (!parsed) continue;
        const score = scoreCandidate(parsed);
        if (score > best.score) best = { key: info.key, obj: parsed, score };
      }

      document.getElementById("debugPicked").textContent = best.key || "none";

      const records = extractRecords(best.obj);
      const verifiedCount = Array.isArray(records) ? records.length : 0;
      const followUpCount = (records || []).filter(isFollowUp).length;

      // Update metrics
      document.getElementById("m_verified").textContent = String(verifiedCount);
      document.getElementById("m_followup").textContent = String(followUpCount);

      // Active users heuristic (based on any tech/user/name-ish fields)
      const users = new Set();
      (records || []).forEach(r => {
        const u = r?.tech || r?.techName || r?.checkedBy || r?.user || r?.initials;
        if (typeof u === "string" && u.trim()) users.add(u.trim());
      });
      document.getElementById("m_users").textContent = users.size ? String(users.size) : "—";

      // Avg time to resolve: placeholder until we can find your timestamps reliably
      document.getElementById("m_ttr").textContent = "—";

      // Needs attention list (show up to 5 follow-up items)
      const attention = (records || [])
        .filter(isFollowUp)
        .slice(-5)
        .reverse()
        .map(r => ({
          left: `⚠️ ${getRecordId(r)} → Needs review`,
          right: "Needs Follow-Up"
        }));

      renderList(document.getElementById("needs_attention"), attention);

      // Recent activity (last 6 records)
      const activity = (records || [])
        .slice(-6)
        .reverse()
        .map(r => {
          const when = getRecordWhen(r);
          const id = getRecordId(r);
          const label = when ? `${when} — ${id} updated` : `${id} updated`;
          return { left: `• ${label}` };
        });

      const activityEl = document.getElementById("activity");
      activityEl.innerHTML = "";
      if (!activity.length) {
        const div = document.createElement("div");
        div.className = "item muted";
        div.textContent = "No recent activity detected yet.";
        activityEl.appendChild(div);
      } else {
        activity.forEach(a => {
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = a.left.replace("• ", "• ");
          activityEl.appendChild(div);
        });
      }
    }

    // Run once on load
    loadDashboard();
  </script>
</body>
</html>
